<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FDM 3D Print Cost Calculator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Import Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            /* Light gray background */
        }

        /* Custom tooltip style */
        .info-icon {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            background-color: #9ca3af;
            /* gray-400 */
            color: white;
            border-radius: 50%;
            text-align: center;
            font-size: 0.75rem;
            line-height: 1rem;
            font-weight: bold;
            font-style: normal;
            cursor: help;
            margin-left: 4px;
            position: relative;
        }

        /* Tooltip text - hidden by default */
        .info-icon::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            /* Position above the icon */
            left: 50%;
            transform: translateX(-50%);
            background-color: #1f2937;
            /* gray-800 */
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            line-height: 1.25;
            white-space: normal;
            width: 320px;
            /* Fixed width for better readability */
            text-align: left;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 10;
        }

        /* Show tooltip on hover */
        .info-icon:hover::after {
            visibility: visible;
            opacity: 1;
        }

        /* Custom style for the sticky summary box */
        .sticky-summary {
            position: sticky;
            top: 1.5rem;
            /* 24px */
            align-self: start;
            /* Prevents stretching to grid height */
        }

        /* Style for the material info boxes */
        .material-info {
            background-color: #f9fafb;
            /* gray-50 */
            border: 1px solid #e5e7eb;
            /* gray-200 */
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }
    </style>
</head>

<body class="h-full bg-gray-100 p-4 sm:p-6 lg:p-8">
    <div class="container mx-auto max-w-7xl">

        <!-- Header -->
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-900">
                <a href="https://www.mdpi.com/2504-4494/9/9/321" target="_blank" rel="noopener noreferrer"
                    class="text-blue-600 hover:underline">
                    FDM 3D Print Cost Calculator
                </a>
            </h1>
            <p class="mt-1 text-lg text-gray-600">A comprehensive tool based on the Seregi & Ficzere (2025) cost model,
                expanded for business and hobbyist quoting.</p>
        </header>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- Column 1: Input Forms -->
            <div class="flex flex-col gap-6">

                <!-- Save/Load Profile -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="save_profile"
                            class="flex-1 bg-blue-600 text-white font-medium py-2 px-4 rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            Save Printer Profile
                        </button>
                        <button id="load_profile"
                            class="flex-1 bg-gray-200 text-gray-800 font-medium py-2 px-4 rounded-lg shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                            Load Printer Profile
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-3 text-center">Saves/Loads all machine, tooling, power, and
                        markup settings. Job-specific parameters are not saved.</p>
                </div>

                <!-- Card 1: Job Parameters -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">1. Job Parameters</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="parts_per_program" class="block text-sm font-medium text-gray-700">
                                Parts per Program
                                <span class="info-icon"
                                    data-tooltip="The total number of identical parts printed in a single print job.">i</span>
                            </label>
                            <input type="number" id="parts_per_program" value="1" min="1" step="1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="program_length_hr" class="block text-sm font-medium text-gray-700">
                                Total Print Time (Hours)
                                <span class="info-icon"
                                    data-tooltip="Total print job duration, in hours. From your slicer's estimate. (e.g., 4.5 for 4h 30m)">i</span>
                            </label>
                            <input type="number" id="program_length_hr" value="1" min="0" step="0.1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="model_material_g" class="block text-sm font-medium text-gray-700">
                                Model Material (grams)
                                <span class="info-icon"
                                    data-tooltip="Total mass of the main model material used, in grams. From your slicer.">i</span>
                            </label>
                            <input type="number" id="model_material_g" value="10" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="support_material_g" class="block text-sm font-medium text-gray-700">
                                Support Material (grams)
                                <span class="info-icon"
                                    data-tooltip="Total mass of support material used, in grams. From your slicer. Enter 0 if no support is used.">i</span>
                            </label>
                            <input type="number" id="support_material_g" value="0" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="failure_rate" class="block text-sm font-medium text-gray-700">
                                Est. Failure Rate (%)
                                <span class="info-icon"
                                    data-tooltip="Amortizes the cost of failed prints across successful ones. A 5% rate means you expect 1 in 20 prints to fail, increasing the cost.">i</span>
                            </label>
                            <input type="number" id="failure_rate" value="5" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                    </div>
                </div>

                <!-- Card 2: Material & Labor -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">2. Material & Labor</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-4">
                        <!-- Model Material -->
                        <div>
                            <label for="model_material_cost_kg" class="block text-sm font-medium text-gray-700">
                                Model Material Cost ($/kg)
                                <span class="info-icon"
                                    data-tooltip="The price you paid for a 1kg roll of your model filament. (e.g., 20)">i</span>
                            </label>
                            <input type="number" id="model_material_cost_kg" value="20" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="model_material_type" class="block text-sm font-medium text-gray-700">Model
                                Material Type</label>
                            <select id="model_material_type"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                <option value="1.24">PLA (1.24 g/cm³)</option>
                                <option value="1.27">PETG (1.27 g/cm³)</option>
                                <option value="1.04">ABS (1.04 g/cm³)</option>
                                <option value="1.06">ASA (1.06 g/cm³)</option>
                                <option value="1.20">TPU/TPE (1.20 g/cm³)</option>
                                <option value="1.08">Nylon (PA) (1.08 g/cm³)</option>
                                <option value="1.20">Polycarbonate (PC) (1.20 g/cm³)</option>
                                <option value="custom">Custom...</option>
                            </select>
                        </div>
                        <div id="model_material_density_custom_wrapper" class="hidden sm:col-span-2">
                            <label for="model_material_density_custom"
                                class="block text-sm font-medium text-gray-700">Custom Model Density (g/cm³)</label>
                            <input type="number" id="model_material_density_custom" value="1.24" min="0" step="0.01"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <!-- Model Material Info Box -->
                        <div id="model_material_info" class="material-info sm:col-span-2">
                            <!-- Content dynamically inserted by JS -->
                        </div>

                        <!-- Support Material -->
                        <div class="sm:col-span-2 border-t pt-4"></div>
                        <div>
                            <label for="support_material_cost_kg" class="block text-sm font-medium text-gray-700">
                                Support Material Cost ($/kg)
                                <span class="info-icon"
                                    data-tooltip="The price you paid for a 1kg roll of your support filament.">i</span>
                            </label>
                            <input type="number" id="support_material_cost_kg" value="20" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="support_material_type" class="block text-sm font-medium text-gray-700">Support
                                Material Type</label>
                            <select id="support_material_type"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                <option value="1.24">PLA (1.24 g/cm³)</option>
                                <option value="1.25">PVA (1.25 g/cm³)</option>
                                <option value="1.06">HIPS (1.06 g/cm³)</option>
                                <option value="1.27">PETG (1.27 g/cm³)</option>
                                <option value="1.04">ABS (1.04 g/cm³)</option>
                                <option value="1.06">ASA (1.06 g/cm³)</option>
                                <option value="custom">Custom...</option>
                            </select>
                        </div>
                        <div id="support_material_density_custom_wrapper" class="hidden sm:col-span-2">
                            <label for="support_material_density_custom"
                                class="block text-sm font-medium text-gray-700">Custom Support Density (g/cm³)</label>
                            <input type="number" id="support_material_density_custom" value="1.24" min="0" step="0.01"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <!-- Support Material Info Box -->
                        <div id="support_material_info" class="material-info sm:col-span-2">
                            <!-- Content dynamically inserted by JS -->
                        </div>

                        <!-- Labor -->
                        <div class="sm:col-span-2 border-t pt-4"></div>
                        <div>
                            <label for="hourly_wage" class="block text-sm font-medium text-gray-700">
                                Labor Rate ($/hour)
                                <span class="info-icon"
                                    data-tooltip="Your hourly rate for all manual labor (prep, post-processing, finishing).">i</span>
                            </label>
                            <input type="number" id="hourly_wage" value="20" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="prep_slicing_time" class="block text-sm font-medium text-gray-700">
                                Prep & Slicing (minutes)
                                <span class="info-icon"
                                    data-tooltip="Time spent on file prep, model orientation, and slicer setup.">i</span>
                            </label>
                            <input type="number" id="prep_slicing_time" value="10" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="manual_labor_time" class="block text-sm font-medium text-gray-700">
                                Post-Print Labor (minutes)
                                <span class="info-icon"
                                    data-tooltip="Time spent per program on setup, part removal, support removal, and cleanup. (Eq 6)">i</span>
                            </label>
                            <input type="number" id="manual_labor_time" value="5" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>

                    </div>
                </div>

                <!-- Card 3: Machine Operation -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">3. Machine Operation</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="printer_cost" class="block text-sm font-medium text-gray-700">
                                Printer Cost ($)
                                <span class="info-icon"
                                    data-tooltip="The total purchase price of your 3D printer. (e.g., Hobbyist: $200-$1,000; Professional: $3,000-$10,000+). Used for depreciation.">i</span>
                            </label>
                            <input type="number" id="printer_cost" value="1000"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="printer_lifespan_hr" class="block text-sm font-medium text-gray-700">
                                Printer Lifespan (hours)
                                <span class="info-icon"
                                    data-tooltip="Estimated total operational hours before the printer is fully depreciated (e.g., 20,000 hours).">i</span>
                            </label>
                            <input type="number" id="printer_lifespan_hr" value="20000" min="1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="maintenance_cost_hr" class="block text-sm font-medium text-gray-700">
                                Maintenance Cost ($/hour)
                                <span class="info-icon"
                                    data-tooltip="Cost of maintenance parts (belts, fans, etc.) amortized per hour. (e.g., $0.05 - $0.25). Hobbyist annual cost ($100-$200) / annual print hours.">i</span>
                            </label>
                            <input type="number" id="maintenance_cost_hr" value="0.10" min="0" step="0.01"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div class="sm:col-span-2 border-t pt-4"></div>
                        <div>
                            <label for="machine_power_w" class="block text-sm font-medium text-gray-700">
                                Avg. Power (Watts)
                                <span class="info-icon"
                                    data-tooltip="Average power consumption of the printer in Watts. (e.g., Ender 3: ~120-150W, Prusa MK3: ~100-130W).">i</span>
                            </label>
                            <input type="number" id="machine_power_w" value="130" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="electricity_cost_kwh" class="block text-sm font-medium text-gray-700">
                                Electricity Cost ($/kWh)
                                <span class="info-icon"
                                    data-tooltip="Your local electricity rate in dollars per kilowatt-hour. (e.g., $0.15)">i</span>
                            </label>
                            <input type="number" id="electricity_cost_kwh" value="0.15" min="0" step="0.01"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                    </div>
                </div>

                <!-- Card 4: Tooling -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">4. Tooling (Eq 5)</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Build Plate -->
                        <div>
                            <label for="build_plate_cost" class="block text-sm font-medium text-gray-700">
                                Build Plate Cost ($)
                                <span class="info-icon"
                                    data-tooltip="Cost of your PEI, Glass, or other build plate.">i</span>
                            </label>
                            <input type="number" id="build_plate_cost" value="30" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="build_plate_lifespan_hr" class="block text-sm font-medium text-gray-700">
                                Build Plate Lifespan (hours)
                                <span class="info-icon"
                                    data-tooltip="Estimated total lifespan in print hours (e.g., PEI/Glass: 5000+).">i</span>
                            </label>
                            <input type="number" id="build_plate_lifespan_hr" value="5000" min="1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>

                        <!-- Model Nozzle -->
                        <div class="sm:col-span-2 border-t pt-4"></div>
                        <div>
                            <label for="model_nozzle_cost" class="block text-sm font-medium text-gray-700">
                                Model Nozzle Cost ($)
                                <span class="info-icon"
                                    data-tooltip="Cost of the nozzle for the model material. (e.g., Brass: $2, Hardened Steel: $15)">i</span>
                            </label>
                            <input type="number" id="model_nozzle_cost" value="2" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="model_nozzle_lifespan_kg" class="block text-sm font-medium text-gray-700">
                                Model Nozzle Lifespan (kg)
                                <span class="info-icon"
                                    data-tooltip="Estimated filament mass (in kg) this nozzle can print. See guide below. (e.g., Brass/PLA: 25kg, Brass/CF: 0.5kg)">i</span>
                            </label>
                            <input type="number" id="model_nozzle_lifespan_kg" value="25" min="0.1" step="0.1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>

                        <!-- Support Nozzle -->
                        <div class="sm:col-span-2 border-t pt-4"></div>
                        <div>
                            <label for="support_nozzle_cost" class="block text-sm font-medium text-gray-700">
                                Support Nozzle Cost ($)
                                <span class="info-icon"
                                    data-tooltip="Cost of the nozzle for the support material. (If same as model, enter 0 and use model nozzle fields)">i</span>
                            </label>
                            <input type="number" id="support_nozzle_cost" value="0" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="support_nozzle_lifespan_kg" class="block text-sm font-medium text-gray-700">
                                Support Nozzle Lifespan (kg)
                                <span class="info-icon"
                                    data-tooltip="Estimated filament mass (in kg) this nozzle can print. (Only if using a separate nozzle for support)">i</span>
                            </label>
                            <input type="number" id="support_nozzle_lifespan_kg" value="25" min="0.1" step="0.1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                    </div>
                </div>

                <!-- Card 5: Finishing & Post-Processing (Optional) -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">5. Finishing & Post-Processing
                        (Optional)</h2>

                    <!-- Mechanical Finishing -->
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Mechanical Finishing</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="finishing_labor_time" class="block text-sm font-medium text-gray-700">
                                Finishing Labor (minutes)
                                <span class="info-icon"
                                    data-tooltip="Time spent per program on sanding, painting, assembly, etc. Added to your total labor cost.">i</span>
                            </label>
                            <input type="number" id="finishing_labor_time" value="0" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="finishing_materials_cost" class="block text-sm font-medium text-gray-700">
                                Finishing Materials ($)
                                <span class="info-icon"
                                    data-tooltip="Cost of non-filament materials per program (primer, paint, glue, screws).">i</span>
                            </label>
                            <input type="number" id="finishing_materials_cost" value="0" min="0" step="0.01"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                    </div>

                    <!-- Chemical Post-Processing -->
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Chemical Post-Processing (Eq 2)</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="solvent_cost_liter" class="block text-sm font-medium text-gray-700">
                                Solvent Cost ($/Liter)
                                <span class="info-icon"
                                    data-tooltip="Cost per liter of your solvent (e.g., D-Limonene for HIPS, Water for PVA). 1 Liter = 1000 cm³">i</span>
                            </label>
                            <input type="number" id="solvent_cost_liter" value="0" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="solving_time_hr" class="block text-sm font-medium text-gray-700">
                                Solving Time (hours)
                                <span class="info-icon"
                                    data-tooltip="Time the part spends in the solvent bath.">i</span>
                            </label>
                            <input type="number" id="solving_time_hr" value="0" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="tank_power_w" class="block text-sm font-medium text-gray-700">
                                Tank Power (Watts)
                                <span class="info-icon"
                                    data-tooltip="Average power consumption of the solvent tank (heater, stirrer).">i</span>
                            </label>
                            <input type="number" id="tank_power_w" value="0" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                    </div>
                </div>

                <!-- Card 6: Markup -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">6. Markup (Optional)</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="markup_percent" class="block text-sm font-medium text-gray-700">
                                Overhead & Profit Markup (%)
                                <span class="info-icon"
                                    data-tooltip="A percentage markup applied to the total cost per part for business overhead and profit. (e.g., 50)">i</span>
                            </label>
                            <input type="number" id="markup_percent" value="0" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                    </div>
                </div>

                <!-- Reference Guides -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">Reference Guides</h2>

                    <!-- Nozzle Lifespan Guide -->
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Nozzle Lifespan Reference Guide</h3>
                    <p class="text-sm text-gray-600 mb-4">Nozzle lifespan depends on the nozzle material and the
                        filament being printed. Abrasive filaments (carbon fiber, glow-in-the-dark, wood-fill) will
                        destroy brass nozzles very quickly.</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left font-medium text-gray-600">Nozzle Material</th>
                                    <th class="px-4 py-2 text-left font-medium text-gray-600">Filament Type</th>
                                    <th class="px-4 py-2 text-left font-medium text-gray-600">Est. Lifespan (kg)</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td class="px-4 py-2 font-medium">Brass</td>
                                    <td class="px-4 py-2">Standard (PLA, ABS, PETG)</td>
                                    <td class="px-4 py-2">10 - 25 kg+</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-2 font-medium">Brass</td>
                                    <td class="px-4 py-2 text-red-600">Abrasive (CF, Wood, Glow)</td>
                                    <td class="px-4 py-2 text-red-600">&lt; 1 kg (as low as 0.25 kg)</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-2 font-medium">Stainless Steel</td>
                                    <td class="px-4 py-2">Standard & Light Abrasive</td>
                                    <td class="px-4 py-2">20 - 50 kg+</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-2 font-medium">Hardened Steel</td>
                                    <td class="px-4 py-2">All, incl. Heavy Abrasive</td>
                                    <td class="px-4 py-2">50 - 100 kg+</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-2 font-medium">Ruby / Nozzle X</td>
                                    <td class="px-4 py-2">All, incl. Heavy Abrasive</td>
                                    <td class="px-4 py-2">100 kg++</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Nozzle Size Guide -->
                    <h3 class="text-lg font-medium text-gray-700 mt-6 mb-2">Nozzle Size Reference Guide</h3>
                    <p class="text-sm text-gray-600 mb-4">Nozzle diameter (size) is a trade-off between print speed and
                        detail.</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left font-medium text-gray-600">Nozzle Size (mm)</th>
                                    <th class="px-4 py-2 text-left font-medium text-gray-600">Typical Use Case</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td class="px-4 py-2 font-medium">0.15 - 0.25</td>
                                    <td class="px-4 py-2">Extreme detail (e.g., miniatures), very slow. Prone to
                                        clogging.</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-2 font-medium">0.40 (Standard)</td>
                                    <td class="px-4 py-2">Best all-around balance of speed and detail. Default on most
                                        printers.</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-2 font-medium">0.60</td>
                                    <td class="px-4 py-2">Faster prints, stronger parts. Good for abrasive filaments.
                                        Loses fine detail.</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-2 font-medium">0.80 - 1.00+</td>
                                    <td class="px-4 py-2">Very fast "draft" prints or large structural parts. Very low
                                        detail.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Footer / References -->
                <footer class="mt-4 text-gray-600 text-xs">
                    <h3 class="font-semibold text-gray-700 mb-2">References</h3>
                    <ul class="list-disc list-inside space-y-1">
                        <li>
                            Seregi, B.L.; Ficzere, P. (2025). Refined Cost Calculation Framework for FDM Parts.
                            <a href="https://www.mdpi.com/2504-4494/9/9/321" target="_blank" rel="noopener noreferrer"
                                class="text-blue-600 hover:underline">
                                jmmp-09-00321
                            </a>
                        </li>
                        <li>
                            Simplify3D (n.d.). Filament Properties Table.
                            <a href="https://www.simplify3d.com/resources/materials-guide/properties-table/"
                                target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">
                                simplify3d.com
                            </a>
                        </li>
                        <li>
                            Nozzle material & lifespan guides (All3DP, Sovol, Creality, 3DJake, etc.)
                        </li>
                        <li>
                            Build plate guides (All3DP, Bambu Lab Forum, Reddit, etc.)
                        </li>
                        <li>
                            Fusion3 Design (n.d.). How Much Does a 3D Printer Cost?
                            <a href="https://www.fusion3design.com/how-much-does-a-3d-printer-cost/" target="_blank"
                                rel="noopener noreferrer" class="text-blue-600 hover:underline">
                                fusion3design.com
                            </a>
                        </li>
                        <li>
                            Machine maintenance guides (EufyMake, Raise3D, Qidi, etc.)
                        </li>
                    </ul>
                </footer>

            </div> <!-- End Column 1 -->

            <!-- Column 2: Cost Summary (Sticky) -->
            <div class="sticky-summary">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-900 border-b pb-3 mb-4">Cost Summary</h2>

                    <!-- Main Display Box -->
                    <div class="bg-blue-600 text-white rounded-lg p-6 mb-4 text-center">
                        <label class="block text-sm font-medium text-blue-200">Final Quoted Price (per Part)</label>
                        <div id="summary_final_quote" class="text-5xl font-bold tracking-tight">
                            $0.00
                        </div>
                        <div id="summary_total_cost_per_part" class="text-sm text-blue-100 opacity-80 mt-1">
                            ($0.00 base cost + $0.00 markup)
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <div class="flex justify-between items-center text-sm font-medium text-gray-600">
                            <span>Total Program Cost (for <span id="summary_parts_count_1">1</span> part):</span>
                            <span id="summary_total_program_cost" class="text-gray-900">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center text-sm font-medium text-gray-600 mt-1">
                            <span>Base Cost (per Part):</span>
                            <span id="summary_base_cost_per_part" class="text-gray-900">$0.00</span>
                        </div>
                    </div>

                    <!-- Cost Breakdown -->
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Cost Breakdown (per Program)</h3>
                    <div class="space-y-2 text-sm">
                        <!-- Material -->
                        <div class="flex justify-between">
                            <span class="text-gray-600">1. Material Cost</span>
                            <span id="summary_material_cost" class="font-medium text-gray-900">$0.00</span>
                        </div>
                        <!-- Labor -->
                        <div class="flex justify-between">
                            <span class="text-gray-600">2. Labor Cost</span>
                            <span id="summary_labor_cost" class="font-medium text-gray-900">$0.00</span>
                        </div>
                        <!-- Machine -->
                        <div class="flex justify-between">
                            <span class="text-gray-600">3. Machine Operation</span>
                            <span id="summary_machine_cost" class="font-medium text-gray-900">$0.00</span>
                        </div>
                        <!-- Tooling -->
                        <div class="flex justify-between">
                            <span class="text-gray-600">4. Tooling</span>
                            <span id="summary_tooling_cost" class="font-medium text-gray-900">$0.00</span>
                        </div>
                        <!-- Finishing -->
                        <div class="flex justify-between">
                            <span class="text-gray-600">5. Finishing & Post-Processing</span>
                            <span id="summary_post_processing_cost" class="font-medium text-gray-900">$0.00</span>
                        </div>
                        <div class="border-t my-2"></div>
                        <!-- Subtotal -->
                        <div class="flex justify-between">
                            <span class="font-semibold text-gray-800">Subtotal (Base Cost)</span>
                            <span id="summary_subtotal_cost" class="font-bold text-gray-900">$0.00</span>
                        </div>
                        <!-- Failure Rate -->
                        <div class="flex justify-between">
                            <span class="text-gray-600">Failure Rate Markup (<span
                                    id="summary_failure_rate">5</span>%)</span>
                            <span id="summary_failure_cost" class="font-medium text-gray-900">$0.00</span>
                        </div>
                        <!-- Total -->
                        <div class="flex justify-between">
                            <span class="font-semibold text-gray-800">Total Program Cost</span>
                            <span id="summary_total_cost" class="font-bold text-gray-900">$0.00</span>
                        </div>
                    </div>

                    <!-- Quick Metrics -->
                    <h3 class="text-lg font-semibold text-gray-800 mt-6 mb-2">Quick Metrics</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Total Print Time</span>
                            <span id="summary_total_time" class="font-medium text-gray-900">1.00 hr</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Total Mass</span>
                            <span id="summary_total_mass" class="font-medium text-gray-900">10 g</span>
                        </div>
                        <div class="border-t my-2"></div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Cost per Print Hour</span>
                            <span id="summary_cost_per_hour" class="font-medium text-gray-900">$0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Cost per Gram</span>
                            <span id="summary_cost_per_gram" class="font-medium text-gray-900">$0.00</span>
                        </div>
                    </div>

                    <!-- Message Box -->
                    <div id="message_box" class="hidden mt-4 p-3 rounded-md text-sm">
                        <!-- Messages inserted here -->
                    </div>

                </div>
            </div> <!-- End Column 2 -->
        </div> <!-- End Main Grid -->
    </div> <!-- End Container -->

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA & CONSTANTS ---

            // Data from Simplify3D Properties Table
            const materialProperties = {
                '1.24': { // PLA
                    name: 'PLA',
                    density: 1.24,
                    extruderTemp: '190-230 °C',
                    bedTemp: '20-60 °C',
                    surface: 'Blue painter\'s tape, glue stick, PEI sheet'
                },
                '1.27': { // PETG
                    name: 'PETG',
                    density: 1.27,
                    extruderTemp: '220-250 °C',
                    bedTemp: '50-75 °C',
                    surface: 'Blue painter\'s tape, PEI sheet (w/ glue stick as release agent)'
                },
                '1.04': { // ABS
                    name: 'ABS',
                    density: 1.04,
                    extruderTemp: '210-250 °C',
                    bedTemp: '80-110 °C',
                    surface: 'Kapton tape, ABS slurry, PEI sheet'
                },
                '1.06': { // ASA
                    name: 'ASA',
                    density: 1.06,
                    extruderTemp: '240-260 °C',
                    bedTemp: '90-110 °C',
                    surface: 'Kapton tape, PEI sheet'
                },
                '1.20': { // TPU/TPE & PC
                    name: 'TPU/TPE',
                    density: 1.20,
                    extruderTemp: '210-230 °C',
                    bedTemp: '20-60 °C',
                    surface: 'Blue painter\'s tape, glue stick'
                },
                '1.08': { // Nylon (PA)
                    name: 'Nylon (PA)',
                    density: 1.08,
                    extruderTemp: '240-260 °C',
                    bedTemp: '70-90 °C',
                    surface: 'Garolite sheet, glue stick on glass'
                },
                'custom': {
                    name: 'Custom',
                    density: null, // Will be user-defined
                    extruderTemp: 'N/A',
                    bedTemp: 'N/A',
                    surface: 'Refer to manufacturer'
                },
                // Support-specific materials
                '1.25': { // PVA
                    name: 'PVA',
                    density: 1.25,
                    extruderTemp: '190-220 °C',
                    bedTemp: '20-60 °C',
                    surface: 'Blue painter\'s tape, PEI sheet (dissolves in water)'
                },
                '1.07': { // HIPS (Corrected density)
                    name: 'HIPS',
                    density: 1.07,
                    extruderTemp: '220-240 °C',
                    bedTemp: '90-110 °C',
                    surface: 'Kapton tape, PEI (dissolves in D-Limonene)'
                }
            };
            // Add Polycarbonate as a separate entry (it shared '1.20' with TPU)
            materialProperties['1.21'] = { // Using 1.21 to differentiate from TPU's 1.20 key, even if density is same
                name: 'Polycarbonate (PC)',
                density: 1.20,
                extruderTemp: '270-310 °C',
                bedTemp: '90-110 °C',
                surface: 'Garolite sheet, PEI sheet with glue stick'
            };
            // Update model dropdown to use new key
            document.getElementById('model_material_type').querySelector('option[value="1.20"]').nextElementSibling.nextElementSibling.value = '1.21';


            // --- DOM Elements ---
            const allInputs = document.querySelectorAll('input, select');
            const messageBox = document.getElementById('message_box');
            const saveProfileButton = document.getElementById('save_profile');
            const loadProfileButton = document.getElementById('load_profile');

            // --- Storage Availability Check ---
            let storageAvailable = false;
            try {
                const testKey = 'fdm_calc_storage_test';
                localStorage.setItem(testKey, 'test');
                localStorage.removeItem(testKey);
                storageAvailable = true;
            } catch (e) {
                storageAvailable = false;
                console.warn("LocalStorage is not available. Profile saving/loading will be disabled.");
                // Disable buttons and show a persistent error
                if (saveProfileButton) saveProfileButton.disabled = true;
                if (loadProfileButton) loadProfileButton.disabled = true;
                if (saveProfileButton) saveProfileButton.classList.add('opacity-50', 'cursor-not-allowed');
                if (loadProfileButton) loadProfileButton.classList.add('opacity-50', 'cursor-not-allowed');

                // Show a message in the *main* message box
                if (messageBox) {
                    messageBox.textContent = 'Profile saving/loading is disabled: Browser storage is not available or blocked.';
                    messageBox.className = 'mt-4 p-3 rounded-md text-sm bg-yellow-100 text-yellow-800';
                    messageBox.classList.remove('hidden');
                }
            }

            // --- HELPER FUNCTIONS ---

            /**
             * Gets the numeric value from an input field.
             * @param {string} id - The ID of the input element.
             * @returns {number} The parsed float value, or 0 if invalid.
             */
            function getVal(id) {
                const el = document.getElementById(id);
                if (!el) {
                    console.warn(`Element with ID ${id} not found.`);
                    return 0;
                }
                const val = parseFloat(el.value);
                return isNaN(val) ? 0 : val;
            }

            /**
             * Formats a number as a currency string.
             * @param {number} num - The number to format.
             * @returns {string} The formatted currency string (e.g., "$1.23").
             */
            function formatCurrency(num) {
                if (isNaN(num)) return "$0.00";
                return num.toLocaleString('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }

            /**
             * Formats a number to a fixed number of decimal places.
             * @param {number} num - The number to format.
             * @param {number} places - The number of decimal places.
             * @returns {string} The formatted number string.
             */
            function formatNum(num, places = 2) {
                if (isNaN(num)) return (0).toFixed(places);
                return num.toFixed(places);
            }

            /**
             * Displays a message to the user.
             * @param {string} text - The message text.
             * @param {'success' | 'error' | 'warn'} type - The message type.
             */
            function showMessage(text, type = 'success') {
                if (!messageBox) return; // Guard clause
                messageBox.textContent = text;
                if (type === 'success') {
                    messageBox.className = 'mt-4 p-3 rounded-md text-sm bg-green-100 text-green-800';
                } else if (type === 'error') {
                    messageBox.className = 'mt-4 p-3 rounded-md text-sm bg-red-100 text-red-800';
                } else { // 'warn'
                    messageBox.className = 'mt-4 p-3 rounded-md text-sm bg-yellow-100 text-yellow-800';
                }
                messageBox.classList.remove('hidden');

                // Hide message after 3 seconds, unless it's the storage warning
                if (text.includes('Browser storage')) return;

                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 3000);
            }

            /**
             * Toggles the visibility of the custom density input.
             * @param {string} selectId - The ID of the material <select> element.
             * @param {string} wrapperId - The ID of the custom density wrapper <div>.
             */
            function toggleCustomDensity(selectId, wrapperId) {
                const select = document.getElementById(selectId);
                const wrapper = document.getElementById(wrapperId);
                if (!select || !wrapper) return;
                if (select.value === 'custom') {
                    wrapper.classList.remove('hidden');
                } else {
                    wrapper.classList.add('hidden');
                }
            }

            /**
             * Gets the density for a selected material.
             * @param {string} typeSelectId - The ID of the material type dropdown.
             * @param {string} customInputId - The ID of the custom density input.
             * @returns {number} The density in g/cm³.
             */
            function getDensity(typeSelectId, customInputId) {
                const typeVal = document.getElementById(typeSelectId).value;
                if (typeVal === 'custom') {
                    return getVal(customInputId);
                }
                // Find the property (key) in our data object
                const prop = materialProperties[typeVal];
                return prop ? prop.density : 1.24; // Default to PLA density if not found
            }

            /**
             * Updates the material info box.
             * @param {string} selectId - The ID of the material <select> element.
             * @param {string} infoBoxId - The ID of the info box <div>.
             */
            function updateMaterialInfo(selectId, infoBoxId) {
                const select = document.getElementById(selectId);
                const infoBox = document.getElementById(infoBoxId);
                if (!select || !infoBox) return;
                const key = select.value;

                if (key === 'custom') {
                    infoBox.innerHTML = `<p class="text-gray-700">Please enter the density for your custom material. Refer to the manufacturer for printing guidelines.</p>`;
                    return;
                }

                const props = materialProperties[key];
                if (!props) {
                    infoBox.innerHTML = '';
                    return;
                }

                infoBox.innerHTML = `
                    <strong class="text-gray-900">${props.name} Properties:</strong>
                    <ul class="list-disc list-inside ml-1 text-gray-700 space-y-1 mt-1">
                        <li><strong>Extruder Temp:</strong> ${props.extruderTemp}</li>
                        <li><strong>Bed Temp:</strong> ${props.bedTemp}</li>
                        <li><strong>Build Surface:</strong> ${props.surface}</li>
                    </ul>
                `;
            }


            // --- MAIN CALCULATION ---

            function calculateCost() {
                // --- 1. Get All Input Values ---

                // Job Parameters
                const N_parts = getVal('parts_per_program');
                const t_program = getVal('program_length_hr'); // hours
                const m_model_g = getVal('model_material_g'); // grams
                const m_support_g = getVal('support_material_g'); // grams
                const failure_rate = getVal('failure_rate') / 100; // as decimal

                // Material & Labor
                const p_model_kg = getVal('model_material_cost_kg'); // $/kg
                const p_support_kg = getVal('support_material_cost_kg'); // $/kg
                const p_hourlywage = getVal('hourly_wage'); // $/hour
                const t_prep_min = getVal('prep_slicing_time'); // minutes
                const t_manual_min = getVal('manual_labor_time'); // minutes

                // Densities
                const d_model = getDensity('model_material_type', 'model_material_density_custom'); // g/cm³
                const d_support = getDensity('support_material_type', 'support_material_density_custom'); // g/cm³

                // Machine Operation
                const p_printer = getVal('printer_cost');
                const t_printer_lifespan = getVal('printer_lifespan_hr');
                const p_maintenance_hr = getVal('maintenance_cost_hr');
                const E_machine_w = getVal('machine_power_w'); // watts
                const p_electricity_kwh = getVal('electricity_cost_kwh'); // $/kWh

                // Tooling
                const p_bed = getVal('build_plate_cost');
                const t_bed_lifespan = getVal('build_plate_lifespan_hr');
                const p_model_tip = getVal('model_nozzle_cost');
                const m_model_tip_lifespan_kg = getVal('model_nozzle_lifespan_kg'); // kg
                const p_support_tip = getVal('support_nozzle_cost');
                const m_support_tip_lifespan_kg = getVal('support_nozzle_lifespan_kg'); // kg

                // Finishing & Post-Processing
                const t_finishing_min = getVal('finishing_labor_time'); // minutes
                const p_finishing_materials = getVal('finishing_materials_cost');
                const p_solvent_liter = getVal('solvent_cost_liter'); // $/Liter
                const t_solving_hr = getVal('solving_time_hr'); // hours
                const E_tank_w = getVal('tank_power_w'); // watts

                // Markup
                const markup_percent = getVal('markup_percent') / 100; // as decimal

                // --- 2. Perform Calculations (based on article) ---

                // --- Helper Calcs: Volumes (V) ---
                // Volume = Mass / Density. V_model and V_support in cm³
                const V_model_total = (d_model > 0) ? (m_model_g / d_model) : 0;
                const V_support_total = (d_support > 0) ? (m_support_g / d_support) : 0;

                // --- Helper Calcs: Lifespan Conversions ---
                // Convert Nozzle Lifespan from mass (kg) to volume (cm³)
                // Lifetime_Volume = (Lifetime_Mass_g / Density)
                const V_m_lifespan = (d_model > 0) ? ((m_model_tip_lifespan_kg * 1000) / d_model) : 0;
                const V_s_lifespan = (d_support > 0) ? ((m_support_tip_lifespan_kg * 1000) / d_support) : 0;


                // --- Cost Component 1: Material (C_material) (Eq 1, modified) ---
                // We use mass (g) and price per kg ($/kg)
                const C_model = (m_model_g / 1000) * p_model_kg;
                const C_support = (m_support_g / 1000) * p_support_kg;
                const C_material_program = C_model + C_support;

                // --- Cost Component 2: Labor (C_labor) (Eq 6, expanded) ---
                const t_total_labor_hr = (t_prep_min + t_manual_min + t_finishing_min) / 60;
                const C_labor_program = p_hourlywage * t_total_labor_hr;

                // --- Cost Component 3: Machine Operation (C_machine) (Eq 3 & 4, expanded) ---
                // C_depreciation ($/hr) = Printer Cost / Printer Lifespan
                const C_depreciation_hr = (t_printer_lifespan > 0) ? (p_printer / t_printer_lifespan) : 0;
                // C_power ($/hr) = (Watts / 1000) * $/kWh
                const C_power_hr = (E_machine_w / 1000) * p_electricity_kwh;
                // C_machine_hr = Depreciation + Maintenance + Power
                const C_machine_hr = C_depreciation_hr + p_maintenance_hr + C_power_hr;
                const C_machine_program = C_machine_hr * t_program;

                // --- Cost Component 4: Tooling (C_tooling) (Eq 5, modified) ---
                // C_bed = (Bed Cost / Bed Lifespan_hr) * Program_hr
                const C_bed = (t_bed_lifespan > 0) ? (p_bed / t_bed_lifespan) * t_program : 0;
                // C_nozzle = (Nozzle Cost / Nozzle Lifespan_cm³) * Volume_cm³
                const C_model_tip = (V_m_lifespan > 0) ? (p_model_tip / V_m_lifespan) * V_model_total : 0;
                // Check if separate support nozzle is used
                const C_support_tip = (p_support_tip > 0 && V_s_lifespan > 0) ?
                    (p_support_tip / V_s_lifespan) * V_support_total : 0;
                // If no separate support nozzle, add support volume to model nozzle wear
                const C_model_tip_extra_wear = (p_support_tip <= 0 && V_m_lifespan > 0) ?
                    (p_model_tip / V_m_lifespan) * V_support_total : 0;

                const C_tooling_program = C_bed + C_model_tip + C_support_tip + C_model_tip_extra_wear;

                // --- Cost Component 5: Post-Processing (C_postprocess) (Eq 2) ---
                // C_solvent = (p_solvent_liter / 1000 cm³) * V_support_cm³
                const C_solvent = (p_solvent_liter / 1000) * V_support_total;
                // C_tank_power = (Tank_Watts / 1000) * $/kWh * Solving_Time_hr
                const C_tank_power = (E_tank_w / 1000) * p_electricity_kwh * t_solving_hr;
                const C_postprocess_program = C_solvent + C_tank_power + p_finishing_materials;

                // --- 3. Calculate Totals (Eq 7, expanded) ---

                // C_subtotal_program = Sum of all base costs
                const C_subtotal_program = C_material_program + C_labor_program + C_machine_program + C_tooling_program + C_postprocess_program;

                // C_failure_markup = Cost to account for failures
                const C_failure_markup = (failure_rate > 0 && failure_rate < 1) ?
                    (C_subtotal_program / (1 - failure_rate)) - C_subtotal_program : 0;

                // C_total_program = Base cost + Failure markup
                const C_total_program = C_subtotal_program + C_failure_markup;

                // C_total_per_part = Total program cost / number of parts
                const C_total_per_part = (N_parts > 0) ? (C_total_program / N_parts) : 0;

                // C_markup_per_part = Markup % applied to cost per part
                const C_markup_per_part = C_total_per_part * markup_percent;

                // C_final_quote = Final price to charge customer
                const C_final_quote = C_total_per_part + C_markup_per_part;

                // --- 4. Calculate Quick Metrics ---
                const total_mass_g = m_model_g + m_support_g;
                const C_per_hour = (t_program > 0) ? (C_total_program / t_program) : 0;
                const C_per_gram = (total_mass_g > 0) ? (C_total_program / total_mass_g) : 0;

                // --- 5. Update UI ---

                // Main Display
                document.getElementById('summary_final_quote').textContent = formatCurrency(C_final_quote);
                document.getElementById('summary_total_cost_per_part').textContent = `(${formatCurrency(C_total_per_part)} base cost + ${formatCurrency(C_markup_per_part)} markup)`;

                // Program/Part Summary
                document.getElementById('summary_parts_count_1').textContent = N_parts;
                document.getElementById('summary_total_program_cost').textContent = formatCurrency(C_total_program);
                document.getElementById('summary_base_cost_per_part').textContent = formatCurrency(C_total_per_part);

                // Cost Breakdown
                document.getElementById('summary_material_cost').textContent = formatCurrency(C_material_program);
                document.getElementById('summary_labor_cost').textContent = formatCurrency(C_labor_program);
                document.getElementById('summary_machine_cost').textContent = formatCurrency(C_machine_program);
                document.getElementById('summary_tooling_cost').textContent = formatCurrency(C_tooling_program);
                document.getElementById('summary_post_processing_cost').textContent = formatCurrency(C_postprocess_program);

                document.getElementById('summary_subtotal_cost').textContent = formatCurrency(C_subtotal_program);
                document.getElementById('summary_failure_rate').textContent = formatNum(failure_rate * 100, 0);
                document.getElementById('summary_failure_cost').textContent = formatCurrency(C_failure_markup);
                document.getElementById('summary_total_cost').textContent = formatCurrency(C_total_program);

                // Quick Metrics
                document.getElementById('summary_total_time').textContent = `${formatNum(t_program, 2)} hr`;
                document.getElementById('summary_total_mass').textContent = `${formatNum(total_mass_g, 1)} g`;
                document.getElementById('summary_cost_per_hour').textContent = formatCurrency(C_per_hour);
                document.getElementById('summary_cost_per_gram').textContent = formatCurrency(C_per_gram);
            }

            // --- PROFILE SAVE/LOAD ---

            // List of all input IDs that are *not* job-specific
            const profileInputIds = [
                'markup_percent', 'printer_cost', 'printer_lifespan_hr', 'maintenance_cost_hr',
                'machine_power_w', 'electricity_cost_kwh',
                'model_material_cost_kg', 'model_material_type', 'model_material_density_custom',
                'support_material_cost_kg', 'support_material_type', 'support_material_density_custom',
                'hourly_wage',
                'build_plate_cost', 'build_plate_lifespan_hr',
                'model_nozzle_cost', 'model_nozzle_lifespan_kg',
                'support_nozzle_cost', 'support_nozzle_lifespan_kg',
                'solvent_cost_liter', 'tank_power_w'
            ];

            function saveProfile() {
                if (!storageAvailable) {
                    showMessage('Error: Browser storage is not available or blocked.', 'error');
                    return;
                }
                try {
                    const profile = {};
                    for (const id of profileInputIds) {
                        const el = document.getElementById(id);
                        if (el) {
                            profile[id] = el.value;
                        }
                    }
                    localStorage.setItem('fdmCalculatorProfile', JSON.stringify(profile));
                    showMessage('Printer profile saved successfully!', 'success');
                } catch (error) {
                    console.error("Failed to save profile:", error);
                    showMessage('Error saving profile. Storage may be full or blocked by browser settings.', 'error');
                }
            }

            function loadProfile() {
                if (!storageAvailable) {
                    showMessage('Error: Browser storage is not available or blocked.', 'error');
                    return;
                }
                try {
                    const profileString = localStorage.getItem('fdmCalculatorProfile');
                    if (!profileString) {
                        showMessage('No saved profile found.', 'error');
                        return;
                    }
                    const profile = JSON.parse(profileString);
                    for (const id of profileInputIds) {
                        if (profile[id] !== undefined) {
                            const el = document.getElementById(id);
                            if (el) {
                                el.value = profile[id];
                            }
                        }
                    }

                    // Trigger updates for custom fields and info boxes
                    toggleCustomDensity('model_material_type', 'model_material_density_custom_wrapper');
                    toggleCustomDensity('support_material_type', 'support_material_density_custom_wrapper');
                    updateMaterialInfo('model_material_type', 'model_material_info');
                    updateMaterialInfo('support_material_type', 'support_material_info');

                    // Recalculate
                    calculateCost();
                    showMessage('Profile loaded successfully!', 'success');
                } catch (error) {
                    console.error("Failed to load profile:", error);
                    showMessage('Error loading profile. Data may be corrupt or blocked by browser settings.', 'error');
                }
            }

            // --- EVENT LISTENERS ---

            // Add 'input' event listener to all inputs to recalculate
            allInputs.forEach(input => {
                input.addEventListener('input', calculateCost);
            });

            // Add listeners for custom density toggles
            document.getElementById('model_material_type').addEventListener('input', () => {
                toggleCustomDensity('model_material_type', 'model_material_density_custom_wrapper');
                updateMaterialInfo('model_material_type', 'model_material_info');
            });
            document.getElementById('support_material_type').addEventListener('input', () => {
                toggleCustomDensity('support_material_type', 'support_material_density_custom_wrapper');
                updateMaterialInfo('support_material_type', 'support_material_info');
            });

            // Add listeners for Save/Load buttons
            if (saveProfileButton) saveProfileButton.addEventListener('click', saveProfile);
            if (loadProfileButton) loadProfileButton.addEventListener('click', loadProfile);

            // --- INITIALIZATION ---

            // Run initial calculation on page load
            calculateCost();
            // Set initial state for info boxes
            updateMaterialInfo('model_material_type', 'model_material_info');
            updateMaterialInfo('support_material_type', 'support_material_info');

        }); // Close DOMContentLoaded
    </script>
</body>

</html>